{
  "info": {
    "_postman_id": "v7-tenant-catalog-tests",
    "name": "multitenancy001-e2e (v7.0 - tenant catalog tests)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "22901965"
  },
  "item": [
    {
      "name": "00 - Bootstrap (v3)",
      "item": [
        {
          "name": "00.01 health",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Health OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "url": "{{base_url}}/actuator/health"
          }
        },
        {
          "name": "00.02 signup",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "if (!pm.environment.get(\"tenant_email\")) {",
                  "    const ts = Date.now();",
                  "    const email = `e2e_${ts}@tenant.local`;",
                  "    pm.environment.set(\"tenant_email\", email);",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Signup OK', () => pm.expect(pm.response.code).to.be.oneOf([200,201]));",
                  "const json = pm.response.json();",
                  "pm.environment.set('account_id', String(json.account.id));",
                  "pm.environment.set('tenant_schema', json.account.tenantSchema);",
                  "pm.environment.set('tenant_slug', json.account.slug);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"displayName\": \"Tenant E2E\",\n  \"loginEmail\": \"{{tenant_email}}\",\n  \"taxIdType\": \"{{tenant_tax_id_type}}\",\n  \"taxIdNumber\": \"{{tenant_tax_id_number}}\",\n  \"password\": \"{{tenant_password}}\",\n  \"confirmPassword\": \"{{tenant_password}}\"\n}"
            },
            "url": "{{base_url}}/api/signup"
          }
        },
        {
          "name": "00.03 tenant login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Tenant login OK', () => pm.expect(pm.response.code).to.eql(200));",
                  "const json = pm.response.json();",
                  "pm.environment.set('tenant_access_token', json.accessToken);",
                  "pm.environment.set('tenant_refresh_token', json.refreshToken);",
                  "pm.environment.set('tenant_user_id', String(json.userId));"
                ]
              }
            }
          ],
          "request": {
            "auth": { "type": "noauth" },
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{tenant_email}}\",\n  \"password\": \"{{tenant_password}}\"\n}"
            },
            "url": "{{base_url}}/api/tenant/auth/login"
          }
        },
        {
          "name": "00.04 tenant me",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Tenant me OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/me"
          }
        }
      ]
    },
    {
      "name": "01 - Category Tests",
      "item": [
        {
          "name": "01.01 create category",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Create category OK', () => pm.expect(pm.response.code).to.be.oneOf([201]));",
                  "const json = pm.response.json();",
                  "pm.environment.set('category_id', String(json.id));",
                  "pm.environment.set('category_name', json.name);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"},
              {"key": "Content-Type", "value": "application/json"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Eletr√¥nicos\"\n}"
            },
            "url": "{{base_url}}/api/tenant/categories"
          }
        },
        {
          "name": "01.02 create another category",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Create category OK', () => pm.expect(pm.response.code).to.be.oneOf([201]));",
                  "const json = pm.response.json();",
                  "pm.environment.set('category_id_2', String(json.id));"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"},
              {"key": "Content-Type", "value": "application/json"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Livros\"\n}"
            },
            "url": "{{base_url}}/api/tenant/categories"
          }
        },
        {
          "name": "01.03 list all categories",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('List categories OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.length).to.be.at.least(2);"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/categories"
          }
        },
        {
          "name": "01.04 get category by id",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Get category OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.id).to.equal(Number(pm.environment.get('category_id')));",
                  "pm.expect(json.name).to.equal('Eletr√¥nicos');"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/categories/{{category_id}}"
          }
        },
        {
          "name": "01.05 update category",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Update category OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.name).to.equal('Eletr√¥nicos Atualizado');"
                ]
              }
            }
          ],
          "request": {
            "method": "PUT",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"},
              {"key": "Content-Type", "value": "application/json"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Eletr√¥nicos Atualizado\"\n}"
            },
            "url": "{{base_url}}/api/tenant/categories/{{category_id}}"
          }
        },
        {
          "name": "01.06 toggle category active",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Toggle active OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ]
              }
            }
          ],
          "request": {
            "method": "PATCH",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/categories/{{category_id}}/toggle-active"
          }
        },
        {
          "name": "01.07 soft delete category",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Soft delete OK', () => pm.expect(pm.response.code).to.be.oneOf([204]));"
                ]
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/categories/{{category_id}}"
          }
        },
        {
          "name": "01.08 restore category",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Restore OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ]
              }
            }
          ],
          "request": {
            "method": "PATCH",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/categories/{{category_id}}/restore"
          }
        }
      ]
    },
    {
      "name": "02 - Subcategory Tests",
      "item": [
        {
          "name": "02.01 create subcategory",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Create subcategory OK', () => pm.expect(pm.response.code).to.be.oneOf([201]));",
                  "const json = pm.response.json();",
                  "pm.environment.set('subcategory_id', String(json.id));"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"},
              {"key": "Content-Type", "value": "application/json"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Smartphones\"\n}"
            },
            "url": "{{base_url}}/api/tenant/subcategories/category/{{category_id_2}}"
          }
        },
        {
          "name": "02.02 list subcategories by category",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('List subcategories OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.length).to.be.at.least(1);"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/subcategories/category/{{category_id_2}}/not-deleted"
          }
        }
      ]
    },
    {
      "name": "03 - Supplier Tests",
      "item": [
        {
          "name": "03.01 create supplier",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Create supplier OK', () => pm.expect(pm.response.code).to.be.oneOf([201]));",
                  "const json = pm.response.json();",
                  "pm.environment.set('supplier_id', json.id);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"},
              {"key": "Content-Type", "value": "application/json"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Fornecedor Teste\",\n  \"email\": \"fornecedor@teste.com\",\n  \"phone\": \"11999999999\",\n  \"document\": \"12345678000199\",\n  \"documentType\": \"CNPJ\"\n}"
            },
            "url": "{{base_url}}/api/tenant/suppliers"
          }
        },
        {
          "name": "03.02 list suppliers",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('List suppliers OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.length).to.be.at.least(1);"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/suppliers"
          }
        }
      ]
    },
    {
      "name": "04 - Product Tests",
      "item": [
        {
          "name": "04.01 create product",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Create product OK', () => pm.expect(pm.response.code).to.be.oneOf([201]));",
                  "const json = pm.response.json();",
                  "pm.environment.set('product_id', json.id);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"},
              {"key": "Content-Type", "value": "application/json"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Smartphone XYZ\",\n  \"sku\": \"SM-001\",\n  \"price\": 1999.99,\n  \"categoryId\": {{category_id_2}},\n  \"subcategoryId\": {{subcategory_id}},\n  \"stockQuantity\": 10,\n  \"brand\": \"Apple\"\n}"
            },
            "url": "{{base_url}}/api/tenant/products/detailed"
          }
        },
        {
          "name": "04.02 list products",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('List products OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.content.length).to.be.at.least(1);"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/products?page=0&size=10"
          }
        },
        {
          "name": "04.03 get product by id",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Get product OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.name).to.equal('Smartphone XYZ');"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/products/{{product_id}}"
          }
        },
        {
          "name": "04.04 update product cost",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Update cost OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ]
              }
            }
          ],
          "request": {
            "method": "PATCH",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/products/{{product_id}}/cost-price?costPrice=1500.00"
          }
        },
        {
          "name": "04.05 toggle product active",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Toggle active OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ]
              }
            }
          ],
          "request": {
            "method": "PATCH",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/products/{{product_id}}/toggle-active"
          }
        }
      ]
    },
    {
      "name": "05 - Product Queries",
      "item": [
        {
          "name": "05.01 list products by category",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('List by category OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/products/category/{{category_id_2}}"
          }
        },
        {
          "name": "05.02 count low stock",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Count low stock OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/products/low-stock/count?threshold=5"
          }
        },
        {
          "name": "05.03 search products",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Search products OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"}
            ],
            "url": "{{base_url}}/api/tenant/products/search?name=Smartphone"
          }
        }
      ]
    },
    {
      "name": "06 - Negative Tests",
      "item": [
        {
          "name": "06.01 create product without category (should fail)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Create without category fails (400)', () => pm.expect(pm.response.code).to.be.oneOf([400]));"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"},
              {"key": "Content-Type", "value": "application/json"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Produto Sem Categoria\",\n  \"sku\": \"SEM-001\",\n  \"price\": 99.99\n}"
            },
            "url": "{{base_url}}/api/tenant/products/detailed"
          }
        },
        {
          "name": "06.02 create duplicate sku (should fail)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Duplicate SKU fails (409)', () => pm.expect(pm.response.code).to.be.oneOf([409]));"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {"key": "Authorization", "value": "Bearer {{tenant_access_token}}"},
              {"key": "X-Tenant", "value": "{{tenant_schema}}"},
              {"key": "Content-Type", "value": "application/json"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Outro Smartphone\",\n  \"sku\": \"SM-001\",\n  \"price\": 1999.99,\n  \"categoryId\": {{category_id_2}}\n}"
            },
            "url": "{{base_url}}/api/tenant/products/detailed"
          }
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "const url = pm.request.url.toString();",
          "",
          "if (url.includes('/api/tenant/')) {",
          "    const token = pm.environment.get(\"tenant_access_token\");",
          "    const schema = pm.environment.get(\"tenant_schema\");",
          "    ",
          "    if (token) {",
          "        pm.request.headers.upsert({ key: \"Authorization\", value: \"Bearer \" + token });",
          "        console.log(\"üîë Token de tenant adicionado para:\", url);",
          "    }",
          "    if (schema) {",
          "        pm.request.headers.upsert({ key: \"X-Tenant\", value: schema });",
          "        console.log(\"üè∑Ô∏è X-Tenant adicionado para:\", url);",
          "    }",
          "}"
        ]
      }
    }
  ]
}