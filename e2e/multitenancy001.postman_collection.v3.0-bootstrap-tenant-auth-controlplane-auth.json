{
  "info": {
    "_postman_id": "e096821c-eb47-4927-89b8-ae84cdfbd5ee",
    "name": "multitenancy001-e2e (v3.0 - bootstrap + tenant auth + controlplane auth)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "22901965"
  },
  "item": [
    {
      "name": "00 - Bootstrap",
      "item": [
        {
          "name": "00.01 health",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Health OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/actuator/health",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "actuator",
                "health"
              ]
            }
          },
          "response": []
        },
        {
          "name": "00.02 signup",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "/**",
                  " * Salva dados do signup no environment para o restante do E2E.",
                  " */",
                  "pm.test(\"Signup: status esperado\", function () {",
                  "  pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
                  "});",
                  "",
                  "const json = pm.response.json();",
                  "",
                  "// Ajuste estes paths se seu payload mudar",
                  "const accountId = json?.account?.id;",
                  "const tenantSchema = json?.account?.tenantSchema;",
                  "const tenantSlug = json?.account?.slug;",
                  "const tenantAdminEmail = json?.tenantAdmin?.email;",
                  "",
                  "pm.test(\"Signup: account.id presente\", function () {",
                  "  pm.expect(accountId, \"account.id\").to.exist;",
                  "});",
                  "",
                  "pm.test(\"Signup: tenantSchema presente\", function () {",
                  "  pm.expect(tenantSchema, \"account.tenantSchema\").to.exist;",
                  "});",
                  "",
                  "// Salva no environment",
                  "pm.environment.set(\"account_id\", String(accountId));",
                  "pm.environment.set(\"tenant_schema\", tenantSchema);",
                  "pm.environment.set(\"tenantSchema\", String(json.account?.tenantSchema || json.tenantSchema || \"\"));",
                  "pm.environment.set(\"tenant_slug\", tenantSlug || \"\");",
                  "pm.environment.set(\"tenant_admin_email\", tenantAdminEmail || \"\");",
                  "",
                  "// Log útil",
                  "console.log(\"signup account_id=\", accountId, \"tenant_schema=\", tenantSchema, \"tenant_email=\", pm.environment.get(\"tenant_email\"));"
                ],
                "type": "text/javascript",
                "packages": {},
                "requests": {}
              }
            },
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "/**\r",
                  " * Gera tenant_email automaticamente se estiver vazio.\r",
                  " * Mantém compatível com Newman e Postman.\r",
                  " */\r",
                  "if (!pm.environment.get(\"tenant_email\")) {\r",
                  "    const ts = Date.now();\r",
                  "    const email = `e2e_${ts}@tenant.local`;\r",
                  "    pm.environment.set(\"tenant_email\", email);\r",
                  "    console.log(\"Generated tenant_email =\", email);\r",
                  "}"
                ],
                "type": "text/javascript",
                "packages": {},
                "requests": {}
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"displayName\": \"Tenant E2E\",\n  \"loginEmail\": \"{{tenant_email}}\",\n  \"taxIdType\": \"{{tenant_tax_id_type}}\",\n  \"taxIdNumber\": \"{{tenant_tax_id_number}}\",\n  \"password\": \"{{tenant_password}}\",\n  \"confirmPassword\": \"{{tenant_password}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/signup",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "signup"
              ]
            }
          },
          "response": []
        },
        {
          "name": "00.03 tenant login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Tenant login status\", function () {",
                  "  pm.expect(pm.response.code).to.eql(200);",
                  "});",
                  "",
                  "const json = pm.response.json();",
                  "",
                  "pm.environment.set(\"tenant_access_token\", json.accessToken);",
                  "pm.environment.set(\"tenant_refresh_token\", json.refreshToken);",
                  "pm.environment.set(\"tenantSchema\", String(json.account?.tenantSchema || json.tenantSchema || \"\"));",
                  "pm.environment.set(\"tenant_schema\", json.tenantSchema);",
                  "pm.environment.set(\"account_id\", String(json.accountId));",
                  "pm.environment.set(\"tenant_email\", json.email);",
                  "",
                  "console.log(\"Saved tenant_access_token length=\", (json.accessToken || \"\").length);",
                  "console.log(\"Saved tenant_schema=\", json.tenantSchema);"
                ],
                "type": "text/javascript",
                "packages": {},
                "requests": {}
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{tenant_email}}\",\n  \"password\": \"{{tenant_password}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/tenant/auth/login",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "auth",
                "login"
              ]
            }
          },
          "response": []
        },
        {
          "name": "00.04 tenant me",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Tenant me OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.id, 'me: id ausente').to.exist;",
                  "pm.expect(json.email, 'me: email ausente').to.exist;",
                  "console.log('tenant me userId=', json.id, 'email=', json.email);"
                ],
                "type": "text/javascript",
                "packages": {},
                "requests": {}
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{tenant_access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{tenant_access_token}}"
              },
              {
                "key": "X-Tenant",
                "value": "{{tenantSchema}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/tenant/me",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "me"
              ]
            }
          },
          "response": []
        }
      ],
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "packages": {},
            "requests": {},
            "exec": [
              "// ================================\r",
              "// Bootstrap - Header X-Tenant auto\r",
              "// ================================\r",
              "\r",
              "const tenantSchema =\r",
              "  pm.environment.get(\"tenantSchema\") ||\r",
              "  pm.environment.get(\"tenant_schema\") ||\r",
              "  pm.environment.get(\"tenant_schema_name\");\r",
              "\r",
              "if (tenantSchema && tenantSchema.trim() !== \"\") {\r",
              "  pm.request.headers.upsert({\r",
              "    key: \"X-Tenant\",\r",
              "    value: tenantSchema\r",
              "  });\r",
              "\r",
              "  console.log(\"X-Tenant aplicado automaticamente:\", tenantSchema);\r",
              "} else {\r",
              "  console.log(\"X-Tenant não definido (ok para signup/health/login)\");\r",
              "}"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "packages": {},
            "requests": {},
            "exec": [
              ""
            ]
          }
        }
      ]
    },
    {
      "name": "01 - Tenant Auth (Refresh/Logout)",
      "item": [
        {
          "name": "01.01 tenant refresh",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/tenant/auth/refresh",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "auth",
                "refresh"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{tenant_refresh_token}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Tenant refresh OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "",
                  "// guarda refresh antigo para validar rotação",
                  "const oldRefresh = pm.environment.get('tenant_refresh_token');",
                  "pm.environment.set('tenant_refresh_token_old', oldRefresh || '');",
                  "",
                  "const json = pm.response.json();",
                  "pm.expect(json.accessToken, 'refresh: accessToken ausente').to.exist;",
                  "pm.expect(json.refreshToken, 'refresh: refreshToken ausente').to.exist;",
                  "",
                  "pm.environment.set('tenant_access_token', String(json.accessToken));",
                  "pm.environment.set('tenant_refresh_token', String(json.refreshToken));",
                  "",
                  "if (json.accountId != null) pm.environment.set('account_id', String(json.accountId));",
                  "if (json.tenantSchema != null) {",
                  "  pm.environment.set('tenantSchema', String(json.tenantSchema));",
                  "  pm.environment.set('tenant_schema', String(json.tenantSchema));",
                  "}",
                  "",
                  "console.log('tenant refresh OK. old_refresh_saved=', (oldRefresh || '').length, 'new_refresh_len=', (json.refreshToken || '').length);"
                ],
                "packages": {},
                "requests": {}
              }
            }
          ]
        },
        {
          "name": "01.02 tenant me (after refresh)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{tenant_access_token}}"
              },
              {
                "key": "X-Tenant",
                "value": "{{tenantSchema}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/tenant/me",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "me"
              ]
            },
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{tenant_access_token}}",
                  "type": "string"
                }
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Tenant me OK (after refresh)', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.id, 'me: id ausente').to.exist;",
                  "pm.expect(json.email, 'me: email ausente').to.exist;",
                  "console.log('tenant me after refresh userId=', json.id, 'email=', json.email);"
                ],
                "packages": {},
                "requests": {}
              }
            }
          ]
        },
        {
          "name": "01.03 tenant refresh (old refresh must fail)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/tenant/auth/refresh",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "auth",
                "refresh"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{tenant_refresh_token_old}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Tenant refresh old token must fail', () => pm.expect(pm.response.code).to.be.oneOf([401]));",
                  "const json = pm.response.json();",
                  "console.log('refresh old token response=', json);"
                ],
                "packages": {},
                "requests": {}
              }
            }
          ]
        },
        {
          "name": "01.04 tenant logout (single device)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/tenant/auth/logout",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "auth",
                "logout"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{tenant_refresh_token}}\",\n  \"allDevices\": false\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Tenant logout OK', () => pm.expect(pm.response.code).to.be.oneOf([200,204]));",
                  "console.log('tenant logout OK');"
                ],
                "packages": {},
                "requests": {}
              }
            }
          ]
        },
        {
          "name": "01.05 tenant refresh (after logout must fail)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/tenant/auth/refresh",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "auth",
                "refresh"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{tenant_refresh_token}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Tenant refresh after logout must fail', () => pm.expect(pm.response.code).to.be.oneOf([401]));",
                  "const json = pm.response.json();",
                  "console.log('refresh after logout response=', json);"
                ],
                "packages": {},
                "requests": {}
              }
            }
          ]
        }
      ]
    },
    {
      "name": "02 - Control Plane Auth (Refresh/Logout)",
      "item": [
        {
          "name": "02.01 controlplane login",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/controlplane/auth/login",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{controlplane_email}}\",\n  \"password\": \"{{controlplane_password}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "if (!pm.environment.get('controlplane_email') || !pm.environment.get('controlplane_password')) {",
                  "  console.warn('controlplane_email/controlplane_password não definidos no environment. Defina antes de rodar.');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane login: status esperado', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.accessToken, 'accessToken ausente no login controlplane').to.exist;",
                  "pm.expect(json.refreshToken, 'refreshToken ausente no login controlplane').to.exist;",
                  "pm.environment.set('controlplane_access_token', String(json.accessToken));",
                  "pm.environment.set('controlplane_refresh_token', String(json.refreshToken));",
                  "if (json.accountId != null) pm.environment.set('controlplane_account_id', String(json.accountId));",
                  "console.log('controlplane login OK. account_id=', pm.environment.get('controlplane_account_id'));"
                ]
              }
            }
          ]
        },
        {
          "name": "02.02 controlplane me",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/controlplane/me",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{controlplane_access_token}}"
              }
            ]
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.environment.set('controlplane_refresh_token_old', pm.environment.get('controlplane_refresh_token') || '');",
                  "pm.test('ControlPlane me OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.email, 'controlplane me: email ausente').to.exist;",
                  "console.log('controlplane me email=', json.email);"
                ]
              }
            }
          ]
        },
        {
          "name": "02.03 controlplane refresh",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/controlplane/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{controlplane_refresh_token}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane refresh OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.accessToken, 'refresh: accessToken ausente').to.exist;",
                  "pm.expect(json.refreshToken, 'refresh: refreshToken ausente').to.exist;",
                  "pm.environment.set('controlplane_access_token', String(json.accessToken));",
                  "pm.environment.set('controlplane_refresh_token_new', String(json.refreshToken));",
                  "console.log('controlplane refresh OK. new_refresh_len=', (json.refreshToken || '').length);"
                ]
              }
            }
          ]
        },
        {
          "name": "02.04 controlplane me (after refresh)",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/controlplane/me",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{controlplane_access_token}}"
              }
            ]
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane me OK (after refresh)', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ]
              }
            }
          ]
        },
        {
          "name": "02.05 controlplane refresh (old refresh must fail)",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/controlplane/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{controlplane_refresh_token_old}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane refresh old token must fail', () => pm.expect(pm.response.code).to.be.oneOf([401]));",
                  "console.log('controlplane old refresh response=', pm.response.json());"
                ]
              }
            }
          ]
        },
        {
          "name": "02.06 controlplane logout (single device)",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/controlplane/auth/logout",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{controlplane_refresh_token_new}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane logout OK', () => pm.expect(pm.response.code).to.be.oneOf([204]));",
                  "console.log('controlplane logout OK');"
                ]
              }
            }
          ]
        },
        {
          "name": "02.07 controlplane refresh (after logout must fail)",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/controlplane/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{controlplane_refresh_token_new}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane refresh after logout must fail', () => pm.expect(pm.response.code).to.be.oneOf([401]));",
                  "console.log('controlplane refresh after logout response=', pm.response.json());"
                ]
              }
            }
          ]
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "packages": {},
        "requests": {},
        "exec": [
          "// Garante que tenant routes sempre mandem os headers corretos.\r",
          "// (Funciona mesmo que você esqueça de setar manualmente em algum request.)\r",
          "const token = pm.environment.get(\"tenant_access_token\");\r",
          "const schema = pm.environment.get(\"tenant_schema\");\r",
          "\r",
          "if (token) {\r",
          "  pm.request.headers.upsert({ key: \"Authorization\", value: \"Bearer \" + token });\r",
          "}\r",
          "if (schema) {\r",
          "  pm.request.headers.upsert({ key: \"X-Tenant\", value: schema });\r",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "packages": {},
        "requests": {},
        "exec": [
          ""
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "X-Tenant",
      "value": ""
    }
  ]
}