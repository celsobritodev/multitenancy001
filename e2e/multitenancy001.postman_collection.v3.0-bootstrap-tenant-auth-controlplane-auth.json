{
  "info": {
    "_postman_id": "fb01de7d-d66a-496d-9856-e4c40cfc0d7e",
    "name": "multitenancy001-e2e (v3.0 - bootstrap + tenant auth + controlplane auth)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "22901965"
  },
  "item": [
    {
      "name": "00 - Bootstrap",
      "item": [
        {
          "name": "00.01 health",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Health OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/actuator/health",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "actuator",
                "health"
              ]
            }
          },
          "response": []
        },
        {
          "name": "00.02 signup",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "/**",
                  " * Salva dados do signup no environment para o restante do E2E.",
                  " */",
                  "pm.test(\"Signup: status esperado\", function () {",
                  "  pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
                  "});",
                  "",
                  "const json = pm.response.json();",
                  "",
                  "const accountId = json?.account?.id;",
                  "const tenantSchema = json?.account?.tenantSchema;",
                  "const tenantSlug = json?.account?.slug;",
                  "const tenantAdminEmail = json?.tenantAdmin?.email;",
                  "",
                  "pm.test(\"Signup: account.id presente\", function () {",
                  "  pm.expect(accountId, \"account.id\").to.exist;",
                  "});",
                  "",
                  "pm.test(\"Signup: tenantSchema presente\", function () {",
                  "  pm.expect(tenantSchema, \"account.tenantSchema\").to.exist;",
                  "});",
                  "",
                  "pm.environment.set(\"account_id\", String(accountId));",
                  "pm.environment.set(\"tenant_schema\", tenantSchema);",
                  "pm.environment.set(\"tenantSchema\", String(json.account?.tenantSchema || json.tenantSchema || \"\"));",
                  "pm.environment.set(\"tenant_slug\", tenantSlug || \"\");",
                  "pm.environment.set(\"tenant_admin_email\", tenantAdminEmail || \"\");",
                  "",
                  "console.log(\"signup account_id=\", accountId, \"tenant_schema=\", tenantSchema, \"tenant_email=\", pm.environment.get(\"tenant_email\"));"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "if (!pm.environment.get(\"tenant_email\")) {",
                  "    const ts = Date.now();",
                  "    const email = `e2e_${ts}@tenant.local`;",
                  "    pm.environment.set(\"tenant_email\", email);",
                  "    console.log(\"Generated tenant_email =\", email);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"displayName\": \"Tenant E2E\",\n  \"loginEmail\": \"{{tenant_email}}\",\n  \"taxIdType\": \"{{tenant_tax_id_type}}\",\n  \"taxIdNumber\": \"{{tenant_tax_id_number}}\",\n  \"password\": \"{{tenant_password}}\",\n  \"confirmPassword\": \"{{tenant_password}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/signup",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "signup"
              ]
            }
          },
          "response": []
        },
        {
          "name": "00.03 tenant login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Tenant login status\", function () {",
                  "  pm.expect(pm.response.code).to.eql(200);",
                  "});",
                  "",
                  "const json = pm.response.json();",
                  "",
                  "pm.environment.set(\"tenant_access_token\", json.accessToken);",
                  "pm.environment.set(\"tenant_refresh_token\", json.refreshToken);",
                  "pm.environment.set(\"tenantSchema\", String(json.account?.tenantSchema || json.tenantSchema || \"\"));",
                  "pm.environment.set(\"tenant_schema\", json.tenantSchema);",
                  "pm.environment.set(\"account_id\", String(json.accountId));",
                  "pm.environment.set(\"tenant_email\", json.email);",
                  "",
                  "console.log(\"Saved tenant_access_token length=\", (json.accessToken || \"\").length);",
                  "console.log(\"Saved tenant_schema=\", json.tenantSchema);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{tenant_email}}\",\n  \"password\": \"{{tenant_password}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/tenant/auth/login",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "auth",
                "login"
              ]
            }
          },
          "response": []
        },
        {
          "name": "00.04 tenant me",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Tenant me OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.id, 'me: id ausente').to.exist;",
                  "pm.expect(json.email, 'me: email ausente').to.exist;",
                  "console.log('tenant me userId=', json.id, 'email=', json.email);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{tenant_access_token}}"
              },
              {
                "key": "X-Tenant",
                "value": "{{tenantSchema}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/tenant/me",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "me"
              ]
            }
          },
          "response": []
        }
      ],
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const tenantSchema = pm.environment.get(\"tenantSchema\") || pm.environment.get(\"tenant_schema\");",
              "if (tenantSchema && tenantSchema.trim() !== \"\") {",
              "  pm.request.headers.upsert({ key: \"X-Tenant\", value: tenantSchema });",
              "  console.log(\"X-Tenant aplicado automaticamente:\", tenantSchema);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "01 - Tenant Auth (Refresh/Logout)",
      "item": [
        {
          "name": "01.01 tenant refresh",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Tenant refresh OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "",
                  "const oldRefresh = pm.environment.get('tenant_refresh_token');",
                  "pm.environment.set('tenant_refresh_token_old', oldRefresh || '');",
                  "",
                  "const json = pm.response.json();",
                  "pm.expect(json.accessToken, 'refresh: accessToken ausente').to.exist;",
                  "pm.expect(json.refreshToken, 'refresh: refreshToken ausente').to.exist;",
                  "",
                  "pm.environment.set('tenant_access_token', String(json.accessToken));",
                  "pm.environment.set('tenant_refresh_token', String(json.refreshToken));",
                  "",
                  "if (json.accountId != null) pm.environment.set('account_id', String(json.accountId));",
                  "if (json.tenantSchema != null) {",
                  "  pm.environment.set('tenantSchema', String(json.tenantSchema));",
                  "  pm.environment.set('tenant_schema', String(json.tenantSchema));",
                  "}",
                  "",
                  "console.log('tenant refresh OK. old_refresh_saved=', (oldRefresh || '').length, 'new_refresh_len=', (json.refreshToken || '').length);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{tenant_refresh_token}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/tenant/auth/refresh",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "auth",
                "refresh"
              ]
            }
          },
          "response": []
        },
        {
          "name": "01.02 tenant me (after refresh)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Tenant me OK (after refresh)', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.id, 'me: id ausente').to.exist;",
                  "pm.expect(json.email, 'me: email ausente').to.exist;",
                  "console.log('tenant me after refresh userId=', json.id, 'email=', json.email);"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{tenant_access_token}}"
              },
              {
                "key": "X-Tenant",
                "value": "{{tenantSchema}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/tenant/me",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "me"
              ]
            }
          },
          "response": []
        },
        {
          "name": "01.03 tenant refresh (old refresh must fail)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Tenant refresh old token must fail', () => pm.expect(pm.response.code).to.be.oneOf([401]));",
                  "const json = pm.response.json();",
                  "console.log('refresh old token response=', json);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{tenant_refresh_token_old}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/tenant/auth/refresh",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "auth",
                "refresh"
              ]
            }
          },
          "response": []
        },
        {
          "name": "01.04 tenant logout (single device)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Tenant logout OK', () => pm.expect(pm.response.code).to.be.oneOf([200,204]));",
                  "console.log('tenant logout OK');"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{tenant_refresh_token}}\",\n  \"allDevices\": false\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/tenant/auth/logout",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "auth",
                "logout"
              ]
            }
          },
          "response": []
        },
        {
          "name": "01.05 tenant refresh (after logout must fail)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Tenant refresh after logout must fail', () => pm.expect(pm.response.code).to.be.oneOf([401]));",
                  "const json = pm.response.json();",
                  "console.log('refresh after logout response=', json);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{tenant_refresh_token}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/tenant/auth/refresh",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "tenant",
                "auth",
                "refresh"
              ]
            }
          },
          "response": []
        }
      ]
    },
    {
      "name": "02 - Control Plane Auth (Refresh/Logout)",
      "item": [
        {
          "name": "02.01 controlplane login",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "if (!pm.environment.get('controlplane_email') || !pm.environment.get('controlplane_password')) {",
                  "  console.warn('controlplane_email/controlplane_password não definidos no environment. Defina antes de rodar.');",
                  "}"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane login: status esperado', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.accessToken, 'accessToken ausente no login controlplane').to.exist;",
                  "pm.expect(json.refreshToken, 'refreshToken ausente no login controlplane').to.exist;",
                  "pm.environment.set('controlplane_access_token', String(json.accessToken));",
                  "pm.environment.set('controlplane_refresh_token', String(json.refreshToken));",
                  "if (json.accountId != null) pm.environment.set('controlplane_account_id', String(json.accountId));",
                  "console.log('controlplane login OK. account_id=', pm.environment.get('controlplane_account_id'));"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{controlplane_email}}\",\n  \"password\": \"{{controlplane_password}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/controlplane/auth/login",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "controlplane",
                "auth",
                "login"
              ]
            }
          },
          "response": []
        },
        {
          "name": "02.02 controlplane me",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.environment.set('controlplane_refresh_token_old', pm.environment.get('controlplane_refresh_token') || '');",
                  "pm.test('ControlPlane me OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.email, 'controlplane me: email ausente').to.exist;",
                  "console.log('controlplane me email=', json.email);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{controlplane_access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/controlplane/me",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "controlplane",
                "me"
              ]
            }
          },
          "response": []
        },
        {
          "name": "02.03 controlplane refresh",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane refresh OK', () => pm.expect(pm.response.code).to.be.oneOf([200]));",
                  "const json = pm.response.json();",
                  "pm.expect(json.accessToken, 'refresh: accessToken ausente').to.exist;",
                  "pm.expect(json.refreshToken, 'refresh: refreshToken ausente').to.exist;",
                  "pm.environment.set('controlplane_access_token', String(json.accessToken));",
                  "pm.environment.set('controlplane_refresh_token_new', String(json.refreshToken));",
                  "console.log('controlplane refresh OK. new_refresh_len=', (json.refreshToken || '').length);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{controlplane_refresh_token}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/controlplane/auth/refresh",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "controlplane",
                "auth",
                "refresh"
              ]
            }
          },
          "response": []
        },
        {
          "name": "02.04 controlplane me (after refresh)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane me OK (after refresh)', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{controlplane_access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/controlplane/me",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "controlplane",
                "me"
              ]
            }
          },
          "response": []
        },
        {
          "name": "02.05 controlplane refresh (old refresh must fail)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane refresh old token must fail', () => pm.expect(pm.response.code).to.be.oneOf([401]));",
                  "console.log('controlplane old refresh response=', pm.response.json());"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{controlplane_refresh_token_old}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/controlplane/auth/refresh",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "controlplane",
                "auth",
                "refresh"
              ]
            }
          },
          "response": []
        },
        {
          "name": "02.06 controlplane logout (single device)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane logout OK', () => pm.expect(pm.response.code).to.be.oneOf([204]));",
                  "console.log('controlplane logout OK');"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{controlplane_refresh_token_new}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/controlplane/auth/logout",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "controlplane",
                "auth",
                "logout"
              ]
            }
          },
          "response": []
        },
        {
          "name": "02.07 controlplane refresh (after logout must fail)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ControlPlane refresh after logout must fail', () => pm.expect(pm.response.code).to.be.oneOf([401]));",
                  "console.log('controlplane refresh after logout response=', pm.response.json());"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{controlplane_refresh_token_new}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/controlplane/auth/refresh",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "controlplane",
                "auth",
                "refresh"
              ]
            }
          },
          "response": []
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "const url = pm.request.url.toString();",
          "",
          "if (url.includes('/api/tenant/') || url.includes('/api/me')) {",
          "    const token = pm.environment.get(\"tenant_access_token\");",
          "    const schema = pm.environment.get(\"tenant_schema\");",
          "    ",
          "    if (token) {",
          "        pm.request.headers.upsert({ key: \"Authorization\", value: \"Bearer \" + token });",
          "        console.log(\"Token de tenant adicionado para:\", url);",
          "    }",
          "    if (schema) {",
          "        pm.request.headers.upsert({ key: \"X-Tenant\", value: schema });",
          "        console.log(\"X-Tenant adicionado para:\", url);",
          "    }",
          "} else if (url.includes('/api/controlplane/')) {",
          "    const token = pm.environment.get(\"controlplane_access_token\");",
          "    ",
          "    if (token) {",
          "        pm.request.headers.upsert({ key: \"Authorization\", value: \"Bearer \" + token });",
          "        console.log(\"Token do Control Plane adicionado para:\", url);",
          "    } else {",
          "        console.log(\"Token do Control Plane não disponível para:\", url);",
          "    }",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [""]
      }
    }
  ],
  "variable": [
    {
      "key": "X-Tenant",
      "value": ""
    }
  ]
}