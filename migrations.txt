

-- ==========================================
-- FILE: src/main/resources/db/migration/accounts/V1__create_accounts.sql
-- ==========================================

-- V1__create_accounts.sql
SET search_path TO public;

CREATE TABLE accounts (
    id BIGSERIAL PRIMARY KEY,

    -- üî• NOVO: Flag para identificar contas do sistema
    is_system_account BOOLEAN NOT NULL DEFAULT false,

    name VARCHAR(150) NOT NULL,

    -- Infra
    schema_name VARCHAR(100) NOT NULL UNIQUE,
    slug VARCHAR(50) NOT NULL UNIQUE,

    -- Status / Plano
    status VARCHAR(50) NOT NULL,
    subscription_plan VARCHAR(50) DEFAULT 'FREE',

    max_users INTEGER DEFAULT 5,
    max_products INTEGER DEFAULT 100,
    max_storage_mb INTEGER DEFAULT 100,

    -- Identidade da empresa (üîë CR√çTICO)
    company_doc_type VARCHAR(10) NOT NULL,
    company_doc_number VARCHAR(20) NOT NULL,
    company_email VARCHAR(150) NOT NULL,

    company_phone VARCHAR(20),
    company_address VARCHAR(500),
    company_city VARCHAR(100),
    company_state VARCHAR(50),
    company_country VARCHAR(50) DEFAULT 'Brasil',

    -- Localiza√ß√£o
    timezone VARCHAR(50) DEFAULT 'America/Sao_Paulo',
    locale VARCHAR(10) DEFAULT 'pt_BR',
    currency VARCHAR(3) DEFAULT 'BRL',

    -- Datas
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    trial_end_date TIMESTAMP,
    payment_due_date TIMESTAMP,
    next_billing_date TIMESTAMP,

    settings_json TEXT,
    metadata_json TEXT,

    deleted BOOLEAN DEFAULT false,
    deleted_at TIMESTAMP
);

-- √çndice √∫nico para documento (somente contas ativas)
CREATE UNIQUE INDEX IF NOT EXISTS ux_accounts_company_document_active
ON accounts (company_doc_number)
WHERE deleted = false;

-- √çndice √∫nico para email (somente contas ativas)
CREATE UNIQUE INDEX IF NOT EXISTS ux_accounts_company_email_active
ON accounts (company_email)
WHERE deleted = false;

-- √çndice √∫nico para schema
CREATE UNIQUE INDEX IF NOT EXISTS uk_accounts_schema_name
ON accounts (schema_name);

-- √çndice √∫nico para slug
CREATE UNIQUE INDEX IF NOT EXISTS uk_accounts_slug
ON accounts (slug);



-- ==========================================
-- FILE: src/main/resources/db/migration/accounts/V2__create_accounts_users.sql
-- ==========================================

-- V2__create_accounts_users.sql
SET search_path TO public;

CREATE TABLE users_account (
    id BIGSERIAL PRIMARY KEY,

    name VARCHAR(100) NOT NULL,
    username VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(150) NOT NULL,

    role VARCHAR(50) NOT NULL,

    account_id BIGINT NOT NULL,
    active BOOLEAN NOT NULL DEFAULT true,

    last_login TIMESTAMP,
    failed_login_attempts INTEGER DEFAULT 0,
    locked_until TIMESTAMP,
    must_change_password BOOLEAN DEFAULT false,
    password_changed_at TIMESTAMP,

    timezone VARCHAR(50) DEFAULT 'America/Sao_Paulo',
    locale VARCHAR(10) DEFAULT 'pt_BR',

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP,
    deleted_at TIMESTAMP,
    deleted BOOLEAN NOT NULL DEFAULT false,

    password_reset_token VARCHAR(255),
    password_reset_expires TIMESTAMP,
    
     -- üìû Extras
    phone VARCHAR(20),
    avatar_url VARCHAR(500),

    CONSTRAINT fk_users_account
        FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE,

    CONSTRAINT ux_users_account_username UNIQUE (account_id, username),
    CONSTRAINT ux_users_account_email UNIQUE (account_id, email)
);

CREATE TABLE accounts_users_permissions (
    user_id BIGINT NOT NULL,
    permission VARCHAR(100) NOT NULL,
    CONSTRAINT fk_user_permissions_user
        FOREIGN KEY (user_id) REFERENCES users_account(id) ON DELETE CASCADE,
    CONSTRAINT ux_user_permission PRIMARY KEY (user_id, permission)
);


-- ==========================================
-- FILE: src/main/resources/db/migration/accounts/V3__insert_platform_account.sql
-- ==========================================

-- V3__insert_platform_account.sql
SET search_path TO public;

INSERT INTO accounts (
    is_system_account,
    name,
    schema_name,
    slug,
    status,
    subscription_plan,
    company_doc_type,
    company_doc_number,
    company_email,
    company_country,
    deleted
)
SELECT
    true, -- üî• Marcada como conta do sistema
    'Platform',
    'public',
    'platform',
    'ACTIVE',
    'FREE',
    'CNPJ',
    '00000000000000',
    'platform@system.com',
    'Brasil',
    false
WHERE NOT EXISTS (
    SELECT 1
    FROM accounts
    WHERE slug = 'platform'
);

-- ==========================================
-- FILE: src/main/resources/db/migration/accounts/V4__insert_accounts_super_admin.sql
-- ==========================================

-- V4__insert_accounts_super_admin.sql
SET search_path TO public;

INSERT INTO users_account (
    name,
    username,
    email,
    password,
    role,
    active,
    account_id
)
SELECT
    'Platform Super Admin',
    'superadmin',
    'admin@platform.com',
    '$2a$10$NHoV1pUU3gMGp87cYuvtReeq1iMqDOeHknZhrgzAcaygIVSuLFSQy',
    'SUPER_ADMIN',
    true,
    a.id
FROM accounts a
WHERE a.slug = 'platform'
AND NOT EXISTS (
    SELECT 1
    FROM users_account u
   WHERE u.account_id = a.id
    AND (u.username = 'superadmin' OR u.email = 'admin@platform.com')
);

-- ==========================================
-- FILE: src/main/resources/db/migration/tenants/V1__create_tenants_users.sql
-- ==========================================

-- V1__create_tenants_users.sql
CREATE TABLE IF NOT EXISTS users_tenant (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- üîó Relacionamento com account 
    account_id BIGINT NOT NULL,

    -- üìõ Dados principais
    name VARCHAR(100) NOT NULL,
    username VARCHAR(100) NOT NULL,
    email VARCHAR(150) NOT NULL,
    password VARCHAR(255) NOT NULL,

    -- üë§ Perfil
    role VARCHAR(50) NOT NULL,
    active BOOLEAN NOT NULL DEFAULT true,

    -- üîê Seguran√ßa / autentica√ß√£o
    last_login TIMESTAMP,
    failed_login_attempts INTEGER NOT NULL DEFAULT 0,
    locked_until TIMESTAMP,
    must_change_password BOOLEAN NOT NULL DEFAULT false,
    password_changed_at TIMESTAMP,
    password_reset_token VARCHAR(255),
    password_reset_expires TIMESTAMP,

    -- üìû Extras
    phone VARCHAR(20),
    avatar_url VARCHAR(500),
   
    -- üåé Internacionaliza√ß√£o
    timezone VARCHAR(50) NOT NULL DEFAULT 'America/Sao_Paulo',
    locale VARCHAR(10) NOT NULL DEFAULT 'pt_BR',

    -- üßæ Auditoria
    created_at TIMESTAMP NOT NULL DEFAULT now(),
    updated_at TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,

    -- üóëÔ∏è Soft delete
    deleted BOOLEAN NOT NULL DEFAULT false,
    deleted_at TIMESTAMP,

    -- üîí Unicidade por tenant
    CONSTRAINT uk_users_tenant_username_account UNIQUE (username, account_id),
    CONSTRAINT uk_users_tenant_email_account UNIQUE (email, account_id)
);



-- Cria √≠ndices para performance
CREATE INDEX idx_users_tenant_account_id ON users_tenant(account_id);
CREATE INDEX idx_users_tenant_username ON users_tenant(username);
CREATE INDEX idx_users_tenant_email ON users_tenant(email);
CREATE INDEX idx_users_tenant_active ON users_tenant(active) WHERE active = true;
CREATE INDEX idx_users_tenant_deleted ON users_tenant(deleted) WHERE deleted = false;

-- ==========================================
-- FILE: src/main/resources/db/migration/tenants/V2__create_tenant_users_permissions.sql
-- ==========================================

-- V2__create_tenant_users_permissions.sql
CREATE TABLE IF NOT EXISTS user_tenant_permissions (
    user_tenant_id BIGINT NOT NULL,
    permission VARCHAR(100) NOT NULL,
    PRIMARY KEY (user_tenant_id, permission),
    CONSTRAINT fk_user_tenant_permissions_user
        FOREIGN KEY (user_tenant_id) 
        REFERENCES users_tenant(id) 
        ON DELETE CASCADE
);

-- ==========================================
-- FILE: src/main/resources/db/migration/tenants/V3__create_categories.sql
-- ==========================================

-- V3__create_categories.sql
CREATE TABLE categories (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  updated_at TIMESTAMP,
  deleted BOOLEAN NOT NULL DEFAULT false,
  deleted_at TIMESTAMP,

  CONSTRAINT uk_categories_name UNIQUE (name)
);


-- ==========================================
-- FILE: src/main/resources/db/migration/tenants/V4__create_subcategories.sql
-- ==========================================

-- V4__create_subcategories.sql
CREATE TABLE subcategories (
  id BIGSERIAL PRIMARY KEY,
  category_id BIGINT NOT NULL,
  name VARCHAR(100) NOT NULL,
  active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  updated_at TIMESTAMP,
  deleted BOOLEAN NOT NULL DEFAULT false,
  deleted_at TIMESTAMP,

  CONSTRAINT fk_subcategories_category
    FOREIGN KEY (category_id) REFERENCES categories(id),

  CONSTRAINT uk_subcategories_name_category UNIQUE (category_id, name),

  -- necess√°rio pra FK composta do products
  CONSTRAINT uk_subcategories_id_category UNIQUE (id, category_id)
);

CREATE INDEX idx_subcategories_category_id ON subcategories(category_id);


-- ==========================================
-- FILE: src/main/resources/db/migration/tenants/V5__create_products.sql
-- ==========================================

-- V5__create_products.sql

-- Se voc√™ usa Postgres, isso √© opcional (geralmente j√° existe):
-- CREATE EXTENSION IF NOT EXISTS "pgcrypto";

CREATE TABLE products (
  id UUID PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  description TEXT,
  sku VARCHAR(100) UNIQUE,
  price NUMERIC(10,2) NOT NULL,

  stock_quantity INT NOT NULL DEFAULT 0,
  min_stock INT,
  max_stock INT,

  cost_price NUMERIC(10,2),
  profit_margin NUMERIC(5,2),

  brand VARCHAR(100),
  weight_kg NUMERIC(8,3),
  dimensions VARCHAR(50),
  barcode VARCHAR(50),

  active BOOLEAN NOT NULL DEFAULT true,

  images_json TEXT,
  attributes_json TEXT,

  supplier_id UUID,

  created_at TIMESTAMP NOT NULL DEFAULT now(),
  updated_at TIMESTAMP,
  deleted BOOLEAN NOT NULL DEFAULT false,
  deleted_at TIMESTAMP,

  category_id BIGINT NOT NULL,
  subcategory_id BIGINT NULL,

  CONSTRAINT fk_products_category
    FOREIGN KEY (category_id) REFERENCES categories(id),

  CONSTRAINT fk_products_subcategory_category
    FOREIGN KEY (subcategory_id, category_id)
    REFERENCES subcategories (id, category_id)

  -- Se voc√™ tiver tabela suppliers, voc√™ pode habilitar isso:
  -- ,CONSTRAINT fk_product_supplier
  --   FOREIGN KEY (supplier_id) REFERENCES suppliers(id)
);

CREATE INDEX idx_product_name ON products(name);
CREATE INDEX idx_product_sku ON products(sku);
CREATE INDEX idx_product_supplier ON products(supplier_id);
CREATE INDEX idx_product_created_at ON products(created_at);
CREATE INDEX idx_products_category_id ON products(category_id);
CREATE INDEX idx_products_subcategory_id ON products(subcategory_id);
