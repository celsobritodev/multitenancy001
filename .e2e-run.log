==> Drop DB (db_multitenancy)
 pg_terminate_backend 
----------------------
(0 linha)

DROP DATABASE
CREATE DATABASE
==> Start app
==> App started (pid=2702). Logs: .e2e-app.log
==> Wait for STARTED
==> App STARTED.
==> Health check
==> Health OK.
==> Patch ENV (effective env for Newman)
[WARN] controlplane_email nÃ£o encontrado, usando fallback
[WARN] controlplane_password nÃ£o encontrado, usando fallback
tenant_email = e2e_1772106346_02a7e5@tenant.local
tenant_password = ***
tenant_tax_id_type = CNPJ
tenant_tax_id_number = 12345678000199
controlplane_email = superadmin@platform.local
controlplane_password = ***
effective_env_written = .env.effective.json
==> ConteÃºdo do arquivo efetivo gerado:
      "key": "controlplane_email",
      "key": "controlplane_password",
==> Run Newman
newman

multitenancy001-e2e (v10.9.2 - FULL - ALL ENDPOINTS - STRICT - tenant ambiguity + diagnostics)

â–¡ ðŸ“¦ 00 - BOOTSTRAP (V3)
â”” 00.01 health
  GET http://localhost:8080/actuator/health [200 OK, 466B, 52ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (GET)
  âˆš  Health OK

â”” 00.02 signup
  POST http://localhost:8080/api/signup [201 Created, 849B, 750ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Signup OK
  â”Œ
  â”‚ 'âœ… Conta criada: ID=2, Schema=t_tenant_e2e_5ef501_cc9d
  â”‚ 96a2'
  â””

â”” 00.03 tenant login
  POST http://localhost:8080/api/tenant/auth/login [200 OK, 2.07kB, 307ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Tenant login OK
  â”Œ
  â”‚ 'âœ… Tenant logado: ID=1'
  â””

â”” 00.04 tenant me
  GET http://localhost:8080/api/tenant/me [200 OK, 789B, 125ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (GET)
  âˆš  Tenant me OK

â”” 00.05 controlplane login (superadmin)
  POST http://localhost:8080/api/controlplane/auth/login [200 OK, 1.67kB, 290ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Login superadmin OK
  â”Œ
  â”‚ 'âœ… Superadmin logado: ID=4'
  â””

â”” 00.06 login as billing manager
  POST http://localhost:8080/api/controlplane/auth/login [200 OK, 1.52kB, 126ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Login billing manager OK

â”” 00.07 login as support
  POST http://localhost:8080/api/controlplane/auth/login [200 OK, 1.54kB, 127ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Login support OK

â”” 00.08 login as operator
  POST http://localhost:8080/api/controlplane/auth/login [200 OK, 1.45kB, 119ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Login operator OK

â–¡ ðŸ” 01 - TENANT AUTH TESTS (V3)
â”” 01.01 tenant refresh
  POST http://localhost:8080/api/tenant/auth/refresh [200 OK, 2.07kB, 90ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Tenant refresh OK

â”” 01.02 tenant logout
  POST http://localhost:8080/api/tenant/auth/logout [204 No Content, 423B, 51ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Tenant logout OK

â–¡ ðŸ” 01 - TENANT AUTH TESTS (V3) / 01.50 - MULTI-TENANT LOGIN AMBIGUITY (V10.6)
â”” 01.50.01 signup tenant #2
  â”Œ
  â”‚ '[v10.8.5] tenant2_email=e2e2_1772106352217_5d3d1a@ten
  â”‚ ant.local'
  â”‚ '[v10.8.5] shared_email=shared_1772106352217_61f5ad@te
  â”‚ nant.local'
  â””
  POST http://localhost:8080/api/signup [201 Created, 860B, 359ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Tenant #2 signup OK
  â”Œ
  â”‚ 'âœ… Tenant #2 criado: ID=3, Schema=t_tenant_e2e_2_3f6d0
  â”‚ b_008226a2, Slug=tenant-e2e-2-3f6d0b'
  â””

â”” 01.50.02 tenant #2 login (admin)
  POST http://localhost:8080/api/tenant/auth/login [200 OK, 2.1kB, 147ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Tenant #2 login OK (direct)

â”” 01.50.03 create shared user in tenant #1
  POST http://localhost:8080/api/tenant/users [201 Created, 800B, 254ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Create shared user (201 or 409 if already exists)

â”” 01.50.04 create shared user in tenant #2
  POST http://localhost:8080/api/tenant/users [201 Created, 800B, 156ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  âˆš  Create shared user (201 or 409 if already exists)

â”” 01.50.04a controlplane list tenant-users (account #1) - shared index check
  GET http://localhost:8080/api/controlplane/accounts/2/tenant-users [200 OK, 836B, 46ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (GET)
  âˆš  ControlPlane list tenant-users OK
  âˆš  Shared email must be present in tenant-users index

â”” 01.50.04b controlplane list tenant-users (account #2) - shared index check
  GET http://localhost:8080/api/controlplane/accounts/3/tenant-users [200 OK, 843B, 28ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (GET)
  âˆš  ControlPlane list tenant-users OK
  âˆš  Shared email must be present in tenant-users index

â”” 01.50.05 tenant login (ambiguous) => 409 TENANT_SELECTION_REQUIRED
  POST http://localhost:8080/api/tenant/auth/login [401 Unauthorized, 659B, 36ms]
  âˆš  No 500 in collection
  âˆš  Status code acceptable for SMOKE (POST)
  â”Œ
  â”‚ 'âš ï¸ Ambiguous login returned 401/INVALID_USER. This us
  â”‚ ually means the shared user exists in tenant schemas, 
  â”‚ but the PUBLIC index (login_identities) was not provis
  â”‚ ioned for that email in both accounts.'
  â”‚ '   Expected: public.login_identities should contain 2
  â”‚  rows for shared_email (subject_type=TENANT_ACCOUNT, a
  â”‚ ccount_id=accountId).'
  â”‚ "   Check DB: SELECT subject_type, account_id, subject
  â”‚ _id, email FROM public.login_identities WHERE email = 
  â”‚ '{{shared_email}}';"
  â””
  1. Ambiguous login must return 409
  2. Error must be TENANT_SELECTION_REQUIRED
  3. Must include challengeId
  4. Must include tenants list in details
  âˆš  Must NOT return token yet
  5â „ AssertionFailure in test-script

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚           executed â”‚             failed â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              iterations â”‚                  1 â”‚                  0 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                requests â”‚                 17 â”‚                  0 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            test-scripts â”‚                 34 â”‚                  1 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      prerequest-scripts â”‚                 21 â”‚                  0 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              assertions â”‚                 57 â”‚                  4 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ total run duration: 4.7s                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ total data received: 11.73kB (approx)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ average response time: 180ms [min: 28ms, max: 750ms, s.d.: 172ms] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[31m  # [39m[31m failure          [39m[31m detail                                                                                                                                                      [39m
[90m    [39m[90m                  [39m[90m                                                                                                                                                             [39m
 1.  AssertionError    Ambiguous login must return 409                                                                                                                             
                       status: expected 401 to deeply equal 409                                                                                                                    
                       at assertion:0 in test-script                                                                                                                               
                       inside "ðŸ” 01 - TENANT AUTH TESTS (V3) / 01.50 - MULTI-TENANT LOGIN AMBIGUITY (V10.6) / 01.50.05 tenant login (ambiguous) => 409 TENANT_SELECTION_REQUIRED" 
[90m    [39m[90m                  [39m[90m                                                                                                                                                             [39m
 2.  AssertionError    Error must be TENANT_SELECTION_REQUIRED                                                                                                                     
                       error/code: expected 'INVALID_USER' to deeply equal 'TENANT_SELECTION_REQUIRED'                                                                             
                       at assertion:1 in test-script                                                                                                                               
                       inside "ðŸ” 01 - TENANT AUTH TESTS (V3) / 01.50 - MULTI-TENANT LOGIN AMBIGUITY (V10.6) / 01.50.05 tenant login (ambiguous) => 409 TENANT_SELECTION_REQUIRED" 
[90m    [39m[90m                  [39m[90m                                                                                                                                                             [39m
 3.  AssertionError    Must include challengeId                                                                                                                                    
                       challengeId: expected undefined to be a string                                                                                                              
                       at assertion:2 in test-script                                                                                                                               
                       inside "ðŸ” 01 - TENANT AUTH TESTS (V3) / 01.50 - MULTI-TENANT LOGIN AMBIGUITY (V10.6) / 01.50.05 tenant login (ambiguous) => 409 TENANT_SELECTION_REQUIRED" 
[90m    [39m[90m                  [39m[90m                                                                                                                                                             [39m
 4.  AssertionError    Must include tenants list in details                                                                                                                        
                       tenants list: expected null to be an array                                                                                                                  
                       at assertion:3 in test-script                                                                                                                               
                       inside "ðŸ” 01 - TENANT AUTH TESTS (V3) / 01.50 - MULTI-TENANT LOGIN AMBIGUITY (V10.6) / 01.50.05 tenant login (ambiguous) => 409 TENANT_SELECTION_REQUIRED" 
[90m    [39m[90m                  [39m[90m                                                                                                                                                             [39m
 5.  AssertionFailure                                                                                                                                                              
                       Ambiguous login must return 409, Error must be TENANT_SELECTION_REQUIRED, Must include challengeId, Must include tenants list in details                    
                       at test-script:39:17                                                                                                                                        
                       inside "ðŸ” 01 - TENANT AUTH TESTS (V3) / 01.50 - MULTI-TENANT LOGIN AMBIGUITY (V10.6) / 01.50.05 tenant login (ambiguous) => 409 TENANT_SELECTION_REQUIRED" 
==> Stopping app (pid=2702)...
